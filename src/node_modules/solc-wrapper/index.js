// //////////////////////////////////////////////////////////////////
// var Compiler = require('./src/compiler/compiler')
// var CompilerInput = require('./src/compiler/compiler-input')
// module.exports = { Compiler, CompilerInput }
// => Provides:
//
//     {
//         InternalCallTree: InternalCallTree,
//         SolidityProxy: SolidityProxy,
//         localDecoder: localDecoder,
//         stateDecoder: stateDecoder,
//         CodeAnalysis: CodeAnalysis
//     }
// //////////////////////////////////////////////////////////////////
const wrapper = require('./wrapper.js')
// const solcABI = require('./abi.js')
// const CompilerImport = require('./handle-imports.js')

/******************************************************************************
  MODULE
******************************************************************************/
/*
  triggers
  - compilationFinished
  - compilerLoaded
  - compilationStarted
  - compilationDuration
*/
module.exports = compiler

function compiler (solc) {
  const _compiler = wrapper(solc)
  const api = {}

  // var zelf = instantiate()
  // var REMIX_SOLIDITY = new Compiler(_compiler, (url, cb) => zelf.importFileCb(url, cb))
  // console.log('REMIX_SOLIDITY', REMIX_SOLIDITY)

  Object.keys(_compiler).forEach(key => {
    if (key === 'compile') {
      // api.compile = function (files /* === main.js */, target) {
      //   console.log('files =', files)
      //   console.log('target =', target)
      //   console.error(`[on:compile:start] solc.compile(files, target)`)
      //   return REMIX_SOLIDITY.compile(files, target)
      // }
      api.compile = function (sourcecode) {
        // console.error(`[on:compile:start] solc.compile(sourcecode)`)
        var data = _compiler.compile(sourcecode, 1)
        // console.log('metadata', data)
        var contracts = data.contracts
        var name = Object.keys(contracts)[0]
        if (name) {
          const {
            // gasEstimates,
            // interface: abi,
            metadata,
          } = contracts[name]
          var settings = JSON.parse(metadata)
          return settings
        } else {
          return contracts.errors
        }
        // return {
        //   "compiler": { "version": settings.compiler.version },
        //   "language": "Solidity",
        //   "output": {
        //     "abi": JSON.parse(abi)
        //   },
        //   "settings": ,
        //   "sources": {},
        //   "version": 1,
        // }
      }
    }
    else if (typeof _compiler[key] === 'function') api[key] = function (...args) {
      console.error(`compiler.${key}(...args)`, args)
      return _compiler[key].apply(_compiler, args)
    }
    else Object.defineProperty(api, key, {
      get () {
        var currentValue = _compiler[key]
        console.error(`compiler.${key} === `, currentValue)
        return currentValue
      },
      set (newValue) {
        console.error(`compiler.${key} = `, newValue)
        return _compiler[key] = newValue
      },
      enumerable: true,
      configurable: true
    })
  })
  return api
}
